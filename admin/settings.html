<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengaturan Sistem - Bank Sampah</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
                <button class="nav-toggle" id="sidebar-toggle">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="customers.html"><i class="fas fa-users"></i> Manajemen Nasabah</a></li>
                <li><a href="waste-types.html"><i class="fas fa-trash-alt"></i> Jenis Sampah</a></li>
                <li><a href="deposits.html"><i class="fas fa-donate"></i> Setor Sampah</a></li>
                <li><a href="withdrawals.html"><i class="fas fa-money-bill-wave"></i> Penarikan</a></li>
                <li><a href="transactions.html"><i class="fas fa-exchange-alt"></i> Riwayat Transaksi</a></li>
                <li><a href="reports.html"><i class="fas fa-chart-bar"></i> Laporan</a></li>
                <li><a href="admins.html"><i class="fas fa-user-shield"></i> Manajemen Admin</a></li>
                <li><a href="settings.html" class="active"><i class="fas fa-cog"></i> Pengaturan Sistem</a></li>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <div class="header-left">
                    <button class="nav-toggle" id="mobile-menu-toggle">
                        <span class="bar"></span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                    </button>
                </div>
                <h1>Pengaturan Sistem</h1>
            </div>

            <div class="settings-container">
                <div class="settings-section">
                    <h2>Pengaturan Umum</h2>
                    <form id="generalSettingsForm">
                        <div class="form-group">
                            <label for="systemName">Nama Sistem</label>
                            <input type="text" id="systemName" class="form-control" placeholder="Nama sistem">
                        </div>
                        <div class="form-group">
                            <label for="systemDescription">Deskripsi Sistem</label>
                            <textarea id="systemDescription" class="form-control" rows="3" placeholder="Deskripsi sistem"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="contactEmail">Email Kontak</label>
                            <input type="email" id="contactEmail" class="form-control" placeholder="Email kontak sistem">
                        </div>
                        <div class="form-group">
                            <label for="contactPhone">Nomor Telepon</label>
                            <input type="tel" id="contactPhone" class="form-control" placeholder="Nomor telepon sistem">
                        </div>
                        <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h2>Pengaturan Admin</h2>
                    <form id="adminSettingsForm">
                        <div class="form-group">
                            <label for="adminUsername">Username Admin</label>
                            <input type="text" id="adminUsername" class="form-control" placeholder="Username admin utama">
                        </div>
                        <div class="form-group">
                            <label for="adminPassword">Password Baru (kosongkan jika tidak ingin mengganti)</label>
                            <input type="password" id="adminPassword" class="form-control" placeholder="Password admin baru">
                        </div>
                        <div class="form-group">
                            <label for="confirmAdminPassword">Konfirmasi Password Baru</label>
                            <input type="password" id="confirmAdminPassword" class="form-control" placeholder="Konfirmasi password baru">
                        </div>
                        <button type="submit" class="btn btn-primary">Simpan Pengaturan Admin</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h2>Pengaturan Notifikasi</h2>
                    <form id="notificationSettingsForm">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="emailNotifications"> Kirim notifikasi melalui email
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="smsNotifications"> Kirim notifikasi melalui SMS
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="notificationEmail">Email untuk Notifikasi</label>
                            <input type="email" id="notificationEmail" class="form-control" placeholder="Email untuk notifikasi">
                        </div>
                        <button type="submit" class="btn btn-primary">Simpan Pengaturan Notifikasi</button>
                    </form>
                </div>

                <div class="settings-section">
                    <h2>Backup dan Reset Data</h2>
                    <div class="backup-section">
                        <div class="form-group">
                            <label>Backup Data</label>
                            <p>Unduh salinan cadangan semua data sistem</p>
                            <button type="button" class="btn btn-secondary" id="backupBtn">Backup Data</button>
                        </div>
                        <div class="form-group">
                            <label>Reset Sistem</label>
                            <p>Reset semua data sistem (akan menghapus semua data nasabah, transaksi, dll.)</p>
                            <button type="button" class="btn btn-danger" id="resetBtn">Reset Sistem</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in as admin
            const isAdmin = localStorage.getItem('isAdminLoggedIn');
            if (isAdmin !== 'true') {
                window.location.href = '../login.html';
                return;
            }

            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                logout();
            });

            // Mobile sidebar toggle functionality
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');

            // Function to toggle sidebar
            function toggleSidebar() {
                sidebar.classList.toggle('active');
            }

            // Add event listeners for sidebar toggle buttons
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleSidebar();
                });
            }

            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleSidebar();
                });
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                const isClickInsideSidebar = sidebar.contains(event.target);
                const isClickOnToggle = event.target === sidebarToggle || event.target === mobileMenuToggle ||
                                        sidebarToggle.contains(event.target) || mobileMenuToggle.contains(event.target);

                if (!isClickInsideSidebar && !isClickOnToggle && window.innerWidth <= 840) {
                    sidebar.classList.remove('active');
                }
            });

            // Handle window resize to ensure proper sidebar state
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 1025) {
                    sidebar.classList.remove('active'); // Ensure sidebar is always visible on desktop
                } else {
                    // On mobile/tablet, keep sidebar hidden by default unless explicitly opened
                    sidebar.classList.remove('active');
                }
            });

            // Load settings
            loadSettings();

            // Form submissions
            document.getElementById('generalSettingsForm').addEventListener('submit', saveGeneralSettings);
            document.getElementById('adminSettingsForm').addEventListener('submit', saveAdminSettings);
            document.getElementById('notificationSettingsForm').addEventListener('submit', saveNotificationSettings);

            // Backup and reset buttons
            document.getElementById('backupBtn').addEventListener('click', backupData);
            document.getElementById('resetBtn').addEventListener('click', resetSystem);
        });

        function loadSettings() {
            // Load general settings
            const settings = getSystemSettings();
            document.getElementById('systemName').value = settings.systemName || 'Bank Sampah';
            document.getElementById('systemDescription').value = settings.systemDescription || 'Sistem Bank Sampah';
            document.getElementById('contactEmail').value = settings.contactEmail || 'info@banksampah.id';
            document.getElementById('contactPhone').value = settings.contactPhone || '(021) 12345678';

            // Load notification settings
            document.getElementById('emailNotifications').checked = settings.emailNotifications || false;
            document.getElementById('smsNotifications').checked = settings.smsNotifications || false;
            document.getElementById('notificationEmail').value = settings.notificationEmail || settings.contactEmail || 'info@banksampah.id';
        }

        function saveGeneralSettings(e) {
            e.preventDefault();
            
            const settings = getSystemSettings();
            settings.systemName = document.getElementById('systemName').value;
            settings.systemDescription = document.getElementById('systemDescription').value;
            settings.contactEmail = document.getElementById('contactEmail').value;
            settings.contactPhone = document.getElementById('contactPhone').value;

            localStorage.setItem('systemSettings', JSON.stringify(settings));
            alert('Pengaturan umum berhasil disimpan');
        }

        function saveAdminSettings(e) {
            e.preventDefault();

            const newUsername = document.getElementById('adminUsername').value;
            const newPassword = document.getElementById('adminPassword').value;
            const confirmNewPassword = document.getElementById('confirmAdminPassword').value;

            if (newPassword && newPassword !== confirmNewPassword) {
                alert('Password baru tidak cocok!');
                return;
            }

            // Update admin credentials
            const admin = JSON.parse(localStorage.getItem('admin')) || {};
            if (newUsername) admin.username = newUsername;
            if (newPassword) admin.password = newPassword;
            localStorage.setItem('admin', JSON.stringify(admin));

            // Clear password fields after saving
            document.getElementById('adminPassword').value = '';
            document.getElementById('confirmAdminPassword').value = '';

            alert('Pengaturan admin berhasil disimpan');
        }

        function saveNotificationSettings(e) {
            e.preventDefault();
            
            const settings = getSystemSettings();
            settings.emailNotifications = document.getElementById('emailNotifications').checked;
            settings.smsNotifications = document.getElementById('smsNotifications').checked;
            settings.notificationEmail = document.getElementById('notificationEmail').value;

            localStorage.setItem('systemSettings', JSON.stringify(settings));
            alert('Pengaturan notifikasi berhasil disimpan');
        }

        function backupData() {
            // Create a backup of all system data
            const backupData = {
                customers: getCustomers(),
                wasteTypes: getWasteTypes(),
                transactions: getTransactions(),
                settings: getSystemSettings(),
                admin: JSON.parse(localStorage.getItem('admin')),
                timestamp: new Date().toISOString()
            };

            // Create and download the backup file
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup-bank-sampah-" + new Date().toISOString().slice(0, 10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            alert('Backup data berhasil diunduh');
        }

        function resetSystem() {
            if (confirm('Apakah Anda yakin ingin mereset semua data sistem? Tindakan ini tidak dapat dibatalkan dan akan menghapus semua data nasabah, transaksi, dan pengaturan.')) {
                if (confirm('Konfirmasi: Anda akan mereset semua data sistem. Apakah Anda benar-benar yakin?')) {
                    // Reset all data except admin credentials
                    const admin = JSON.parse(localStorage.getItem('admin')) || {username: 'admin', password: 'admin123'};
                    
                    localStorage.clear();
                    localStorage.setItem('admin', JSON.stringify(admin));
                    
                    initializeData(); // Reinitialize default data
                    alert('Sistem berhasil direset ke pengaturan awal');
                    window.location.href = 'dashboard.html';
                }
            }
        }

        function getSystemSettings() {
            return JSON.parse(localStorage.getItem('systemSettings')) || {};
        }
    </script>

    <style>
        .settings-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .settings-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .settings-section h2 {
            margin-bottom: 1.5rem;
            color: #2d5016;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
        }

        .backup-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        @media screen and (min-width: 992px) {
            .settings-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</body>
</html>